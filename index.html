<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NKR‑KA Digital Transactions – Dashboard</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{ --footer-h:56px; }
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    .glass{background: rgba(255,255,255,0.6); backdrop-filter: blur(6px);} 
    .kpibox{border-radius:12px;padding:14px}
    .good{background:#e6ffed}
    .warning{background:#fff7e6}
    .bad{background:#ffe6e6}
    .hidden{display:none}
    .table-scroll{max-height:360px; overflow:auto}
    .tab-btn[aria-selected="true"]{border-bottom:3px solid #ef4444; font-weight:600}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
    /* keep footer off login and pinned on dashboard */
    #app-footer{height:var(--footer-h)}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
  <!-- Global Header (shown on all pages except login) -->
  <header id="app-header" class="hidden bg-white/70 glass sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">NKR‑KA Digital Transactions</h1>
      <div class="flex items-center gap-3 text-sm">
        <span id="current-user">—</span>
        <button id="btn-logout" class="px-3 py-1.5 rounded-lg bg-red-600 text-white">Logout</button>
      </div>
    </div>
  </header>

  <!-- Page: Login -->
  <main id="page-login" class="min-h-[80vh] flex items-center justify-center p-6">
    <div class="w-full max-w-md glass p-6 rounded-2xl shadow">
      <h2 class="text-xl font-semibold mb-4">Sign in</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Username</label>
          <input id="login-username" class="border p-2 rounded w-full" placeholder="e.g. superadmin" />
        </div>
        <div>
          <label class="block text-sm mb-1">Password</label>
          <input id="login-password" type="password" class="border p-2 rounded w-full" placeholder="password" />
        </div>
        <div class="flex gap-2 pt-1">
          <button id="btn-login" class="px-4 py-2 rounded bg-red-600 text-white">Login</button>
          <button id="btn-reset-data" class="px-4 py-2 rounded bg-yellow-100 text-sm">Reset Defaults</button>
        </div>
        <div id="auth-message" class="text-xs text-gray-600"></div>
        <div class="text-xs text-gray-500 mt-2">
          Default passwords → superadmin <code>Super@2025</code>, admin <code>Admin@2025</code>, karna <code>Karna@2025</code>, nkro <code>Nkro@2025</code>, skro <code>Skro@2025</code>, bgro <code>Bgro@2025</code>.
        </div>
      </div>
    </div>
  </main>

  <!-- Page: Dashboard (only after login) -->
  <main id="page-dashboard" class="hidden pt-6 pb-[calc(var(--footer-h)+16px)]">
    <div class="max-w-7xl mx-auto px-6">
      <!-- Global metric toggle -->
      <div class="glass p-3 rounded-lg mb-4 flex items-center gap-4 flex-wrap">
        <div class="text-sm font-medium">Metric mode:</div>
        <label class="text-sm flex items-center gap-1"><input type="radio" name="globalMetric" value="count" checked> Count</label>
        <label class="text-sm flex items-center gap-1"><input type="radio" name="globalMetric" value="amount"> Amount (₹)</label>
        <label class="text-sm flex items-center gap-1"><input type="checkbox" id="chk-dual-kpi"> Show both KPI sets side‑by‑side</label>
      </div>

      <!-- Tab Bar -->
      <nav class="border-b mb-4">
        <ul class="flex gap-6" role="tablist">
          <li><button class="tab-btn py-2" data-tab="overview" aria-selected="true">Overview</button></li>
          <li><button class="tab-btn py-2" data-tab="channels">Channels</button></li>
          <li><button class="tab-btn py-2" data-tab="offices">Offices</button></li>
          <li><button class="tab-btn py-2" data-tab="data">Data</button></li>
          <li><button class="tab-btn py-2" data-tab="reports">Reports</button></li>
          <li id="tab-admin-li" class="hidden"><button class="tab-btn py-2" data-tab="admin">Admin</button></li>
        </ul>
      </nav>

      <!-- Tab: Overview -->
      <section data-tabpanel="overview">
        <!-- KPI rows: single or dual -->
        <div id="kpi-wrapper" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"></div>
        <div id="kpi-wrapper-amount" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"></div>

        <!-- Per-channel summary cards (dual lines and color-coded) -->
        <div class="glass rounded p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Summary by Transaction Type</h3>
            <div class="text-sm flex items-center gap-2">
              <span>Tiles show:</span>
              <select id="sel-tile-metric" class="border rounded p-1 text-sm">
                <option value="both">Both</option>
                <option value="count">Count</option>
                <option value="amount">Amount (₹)</option>
              </select>
            </div>
          </div>
          <div id="overview-summary" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
        </div>

        <!-- Chart controls + charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-3 glass rounded">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">Transactions by Channel</h3>
              <div class="flex items-center gap-2 text-sm">
                <label>Graph:</label>
                <select id="sel-chart-type" class="border rounded p-1 text-sm">
                  <option value="bar">Bar</option>
                  <option value="line">Line</option>
                  <option value="pie">Pie</option>
                  <option value="doughnut">Doughnut</option>
                  <option value="radar">Radar</option>
                  <option value="polarArea">Polar Area</option>
                </select>
                <label>Metric:</label>
                <select id="sel-chart-metric-main" class="border rounded p-1 text-sm">
                  <option value="global">Follow Global</option>
                  <option value="count">Count</option>
                  <option value="amount">Amount (₹)</option>
                </select>
              </div>
            </div>
            <canvas id="chart-channels" height="240"></canvas>
          </div>
          <div class="p-3 glass rounded">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">Top Offices by Digital %</h3>
              <div class="text-sm">(based on selected metric)</div>
            </div>
            <canvas id="chart-top-offices" height="240"></canvas>
          </div>
        </div>
      </section>

      <!-- Tab: Channels -->
      <section data-tabpanel="channels" class="hidden">
        <div class="p-3 glass rounded mb-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Channel Mix</h3>
            <div class="flex items-center gap-2 text-sm">
              <label>Graph:</label>
              <select id="sel-chart-type-2" class="border rounded p-1 text-sm">
                <option value="bar">Bar</option>
                <option value="line">Line</option>
                <option value="pie">Pie</option>
                <option value="doughnut">Doughnut</option>
                <option value="radar">Radar</option>
                <option value="polarArea">Polar Area</option>
              </select>
              <label>Metric:</label>
              <select id="sel-chart-metric-2" class="border rounded p-1 text-sm">
                <option value="global">Follow Global</option>
                <option value="count">Count</option>
                <option value="amount">Amount (₹)</option>
              </select>
            </div>
          </div>
          <canvas id="chart-channels-2" height="260"></canvas>
        </div>
      </section>

      <!-- Tab: Offices -->
      <section data-tabpanel="offices" class="hidden">
        <div class="p-3 glass rounded mb-3">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Top 20 Offices by Digital</h3>
            <div class="flex items-center gap-2 text-sm">
              <label>Metric:</label>
              <select id="sel-office-metric" class="border rounded p-1 text-sm">
                <option value="global">Follow Global</option>
                <option value="count">Count</option>
                <option value="amount">Amount (₹)</option>
              </select>
            </div>
          </div>
          <canvas id="chart-top-offices-2" height="260"></canvas>
        </div>
        <div class="p-3 glass rounded">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Cash vs Digital by Office (Stacked)</h3>
            <div class="flex items-center gap-2 text-sm">
              <label>Metric:</label>
              <select id="sel-office-stack-metric" class="border rounded p-1 text-sm">
                <option value="global">Follow Global</option>
                <option value="count">Count</option>
                <option value="amount">Amount (₹)</option>
              </select>
            </div>
          </div>
          <canvas id="chart-office-stacked" height="280"></canvas>
        </div>
      </section>

      <!-- Tab: Data -->
      <section data-tabpanel="data" class="hidden">
        <div class="glass p-4 rounded-md mb-4">
          <div class="flex items-center gap-4 flex-wrap">
            <div>
              <label class="block text-sm">Upload daily CSV (template)</label>
              <input id="csv-upload" type="file" accept=".csv" />
            </div>
            <div>
              <label class="block text-sm">Filter Office</label>
              <select id="filter-office" class="border p-1 rounded"></select>
            </div>
            <div>
              <label class="block text-sm">Search</label>
              <input id="search-text" placeholder="search office or product" class="border p-1 rounded" />
            </div>
          </div>
        </div>
        <div class="p-3 glass rounded">
          <h3 class="font-semibold mb-2">Data Table</h3>
          <div class="table-scroll border rounded">
            <table id="data-table" class="min-w-full text-sm">
              <thead class="bg-gray-100 sticky top-0"><tr id="table-headers"></tr></thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Tab: Reports -->
      <section data-tabpanel="reports" class="hidden">
        <div class="glass p-4 rounded-md mb-4 flex items-center gap-3 flex-wrap">
          <button id="btn-export-csv" class="px-3 py-1 rounded bg-blue-600 text-white text-sm">Export CSV</button>
          <button id="btn-export-pdf" class="px-3 py-1 rounded bg-gray-700 text-white text-sm">Export PDF</button>
          <button id="btn-download-template" class="px-3 py-1 rounded bg-gray-200 text-sm">Download Template CSV</button>
        </div>
      </section>
    </div>
  </main>

  <!-- App footer (hidden on login, pinned on dashboard) -->
  <footer id="app-footer" class="hidden fixed bottom-0 left-0 right-0 bg-white/80 glass border-t text-xs text-gray-600">
    <div class="max-w-7xl mx-auto px-6 h-full flex items-center">© NKR‑KA Digital Transactions Monitoring</div>
  </footer>

<script>
// ===== App State & Config =====
const APP_VERSION = '2025-11-13-metric-toggle-v1';
const DEFAULT_PASSWORDS = { superadmin:'Super@2025', admin:'Admin@2025', karna:'Karna@2025', nkro:'Nkro@2025', skro:'Skro@2025', bgro:'Bgro@2025' };
const DEFAULT_USERS = { superadmin:{passwordHash:'',role:'superadmin'}, admin:{passwordHash:'',role:'admin'}, karna:{passwordHash:'',role:'karna'}, nkro:{passwordHash:'',role:'nkro'}, skro:{passwordHash:'',role:'skro'}, bgro:{passwordHash:'',role:'bgro'} };
let SETTINGS = {digitalChannels:['credit-card','debit-card','upi','neft','rtgs','wallet','qr-scan','posb','ippb'], columns: []};
const CHANNELS = ['cash','cheque','contract','credit-card','debit-card','upi','neft','rtgs','wallet','qr-scan','posb','ippb'];
let STATE = {user:null, rawData:[], filteredData:[], globalMetric:'count', dualKPI:false};
const fmtINR = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0});

// Color map for summary tiles
const TILE_COLORS = {
  cash:'bg-rose-50', cheque:'bg-amber-50', contract:'bg-yellow-50', 'credit-card':'bg-indigo-50', 'debit-card':'bg-sky-50', upi:'bg-emerald-50', neft:'bg-teal-50', rtgs:'bg-cyan-50', wallet:'bg-fuchsia-50', 'qr-scan':'bg-lime-50', posb:'bg-purple-50', ippb:'bg-pink-50'
};

// ===== Helpers =====
async function sha256(msg){ const enc=new TextEncoder(); const data=enc.encode(msg); const hash=await crypto.subtle.digest('SHA-256',data); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function saveSettings(){ localStorage.setItem('dt_settings', JSON.stringify(SETTINGS)); }
function loadSettings(){ SETTINGS = JSON.parse(localStorage.getItem('dt_settings')) || SETTINGS; }
function saveSession(){ localStorage.setItem('dt_session', JSON.stringify(STATE.user)); }
function loadSession(){ try{ STATE.user = JSON.parse(localStorage.getItem('dt_session')); }catch(e){ STATE.user=null; } }
function showMsg(msg,id='auth-message'){ const el=document.getElementById(id); if(el) el.innerText=msg; }

// ===== Init Defaults =====
async function initDefaults(){
  const storedVersion = localStorage.getItem('dt_version');
  const needFreshUsers = !localStorage.getItem('dt_users') || storedVersion !== APP_VERSION;
  if(needFreshUsers){ const users=JSON.parse(JSON.stringify(DEFAULT_USERS)); for(const u in users){ users[u].passwordHash = await sha256(DEFAULT_PASSWORDS[u]||'Password@123'); } localStorage.setItem('dt_users', JSON.stringify(users)); localStorage.setItem('dt_version', APP_VERSION); }
  if(!localStorage.getItem('dt_settings')){ localStorage.setItem('dt_settings', JSON.stringify(SETTINGS)); } else { loadSettings(); }
}

// ===== Router (hash-based) =====
function requireAuth(){ if(!STATE.user){ location.hash = '#/login'; return false;} return true; }
function navigate(){
  const route = location.hash || '#/login';
  const header = document.getElementById('app-header');
  const footer = document.getElementById('app-footer');
  const loginPage = document.getElementById('page-login');
  const dashPage = document.getElementById('page-dashboard');
  if(route.startsWith('#/dashboard')){
    if(!requireAuth()) return;
    header.classList.remove('hidden');
    footer.classList.remove('hidden');
    loginPage.classList.add('hidden');
    dashPage.classList.remove('hidden');
    document.getElementById('current-user').innerText = `${STATE.user.username} (${STATE.user.role})`;
    document.getElementById('tab-admin-li').classList.toggle('hidden', STATE.user.role!=='superadmin');
    if(!route.includes('?tab=')) showTab('overview');
  } else {
    header.classList.add('hidden');
    footer.classList.add('hidden');
    dashPage.classList.add('hidden');
    loginPage.classList.remove('hidden');
  }
}
window.addEventListener('hashchange', navigate);

// ===== Auth =====
async function login(){
  const user = document.getElementById('login-username').value.trim();
  const pwd = document.getElementById('login-password').value;
  if(!user||!pwd){ showMsg('Enter username & password'); return }
  const users = JSON.parse(localStorage.getItem('dt_users'));
  if(!users[user]){ showMsg('User not found'); return }
  const hash = await sha256(pwd);
  if(hash!==users[user].passwordHash){ showMsg('Invalid password'); return }
  STATE.user = {username: user, role: users[user].role};
  saveSession();
  location.hash = '#/dashboard';
}
function logout(){ STATE.user=null; localStorage.removeItem('dt_session'); location.hash = '#/login'; }

// ===== Metric utilities =====
function sumNumeric(row, cols){ return cols.reduce((s,c)=>{ const v=parseFloat((row[c]||'').toString().replace(/[^0-9.-]/g,'')); return s+(isNaN(v)?0:v)},0); }
function sumCount(row, cols){ return cols.reduce((s,c)=>{ const v=parseFloat((row[c]||'').toString().replace(/[^0-9.-]/g,'')); return s+(isNaN(v)?0:Math.round(v)); },0); }
function getChannelCounts(){ const present = CHANNELS.filter(ch=> SETTINGS.columns.includes(ch)); const counts={}; for(const ch of present){ counts[ch]=0; } for(const r of STATE.filteredData){ for(const ch of present){ counts[ch]+= sumCount(r,[ch]); } } return {present, counts}; }
function getChannelAmounts(){ const present = CHANNELS.filter(ch=> SETTINGS.columns.includes(ch)); const amts={}; for(const ch of present){ amts[ch]=0; } for(const r of STATE.filteredData){ for(const ch of present){ amts[ch]+= sumNumeric(r,[ch]); } } return {present, amts}; }

// ===== Tabs =====
function showTab(name){
  document.querySelectorAll('[data-tabpanel]').forEach(sec=>{ sec.classList.toggle('hidden', sec.getAttribute('data-tabpanel')!==name); });
  document.querySelectorAll('.tab-btn').forEach(btn=>{ btn.setAttribute('aria-selected', String(btn.dataset.tab===name)); });
  if(name==='overview'||name==='channels'||name==='offices'){ renderAll(); }
}

// ===== Data & UI =====
function prepareFilters(){ const select=document.getElementById('filter-office'); if(!select) return; select.innerHTML=''; const offices=Array.from(new Set(STATE.rawData.map(r=>r['office-name']||r['office']||'Unknown'))).sort(); const opt=document.createElement('option'); opt.value=''; opt.innerText='All Offices'; select.appendChild(opt); for(const o of offices){ const oel=document.createElement('option'); oel.value=o; oel.innerText=o; select.appendChild(oel); } }
function applyFilters(){ let d=STATE.rawData.slice(); const f=(document.getElementById('filter-office')||{}).value||''; const s=((document.getElementById('search-text')||{}).value||'').trim().toLowerCase(); if(f) d=d.filter(r=>(r['office-name']||r['office']||'').toString()===f); if(s) d=d.filter(r=> Object.values(r).join(' ').toLowerCase().includes(s)); STATE.filteredData=d; renderTable(); renderAll(); }
function renderTable(){ const th=document.getElementById('table-headers'); const tbody=document.getElementById('table-body'); if(!th||!tbody) return; th.innerHTML=''; tbody.innerHTML=''; const cols=SETTINGS.columns; for(const c of cols){ const thc=document.createElement('th'); thc.className='p-2 text-left'; thc.innerText=c; th.appendChild(thc); } for(const row of STATE.filteredData){ const tr=document.createElement('tr'); for(const c of cols){ const td=document.createElement('td'); td.className='p-2'; td.innerText=row[c]===undefined?'':row[c]; tr.appendChild(td);} tbody.appendChild(tr);} }

function renderKPIs(){
  const kpiWrap = document.getElementById('kpi-wrapper');
  const kpiWrapAmt = document.getElementById('kpi-wrapper-amount');
  kpiWrap.innerHTML=''; kpiWrapAmt.innerHTML='';

  // COUNT metrics
  const {present:pc, counts} = getChannelCounts();
  const totalCount = pc.reduce((t,ch)=> t+(counts[ch]||0), 0);
  const digitalSet = SETTINGS.digitalChannels.filter(ch=> pc.includes(ch));
  const digitalCount = digitalSet.reduce((t,ch)=> t+(counts[ch]||0), 0);
  const cashCount = pc.includes('cash') ? (counts['cash']||0) : 0;
  const convCount = cashCount+digitalCount>0 ? ((digitalCount/(cashCount+digitalCount))*100).toFixed(2) : '0.00';

  // AMOUNT metrics
  const {present:pa, amts} = getChannelAmounts();
  const totalAmt = pa.reduce((t,ch)=> t+(amts[ch]||0), 0);
  const digitalAmt = SETTINGS.digitalChannels.filter(ch=> pa.includes(ch)).reduce((t,ch)=> t+(amts[ch]||0), 0);
  const cashAmt = pa.includes('cash') ? (amts['cash']||0) : 0;
  const convAmt = cashAmt+digitalAmt>0 ? ((digitalAmt/(cashAmt+digitalAmt))*100).toFixed(2) : '0.00';

  // Build KPI cards
  function card(label, value, extraClass='good'){ const div=document.createElement('div'); div.className=`kpibox glass p-4 ${extraClass}`; div.innerHTML=`<div class='text-sm'>${label}</div><div class='text-2xl font-bold'>${value}</div>`; return div; }
  // Show according to global + dual toggle
  const mode = STATE.globalMetric; const dual = STATE.dualKPI;
  const kpiCountRow=[ card('Total Transactions (count)', totalCount.toLocaleString(),'good'), card('Digital (count)', digitalCount.toLocaleString(),'warning'), card('Conversion (Cash → Digital)', convCount+'%','bad')];
  const kpiAmtRow=[ card('Total Transactions (amount)', fmtINR.format(totalAmt),'good'), card('Digital (amount)', fmtINR.format(digitalAmt),'warning'), card('Conversion (Cash → Digital)', convAmt+'%','bad')];

  if(mode==='count' && !dual){ kpiWrap.append(...kpiCountRow); kpiWrapAmt.classList.add('hidden'); }
  else if(mode==='amount' && !dual){ kpiWrap.append(...kpiAmtRow); kpiWrapAmt.classList.add('hidden'); }
  else { // dual
    kpiWrap.append(...kpiCountRow);
    kpiWrapAmt.classList.remove('hidden');
    kpiWrapAmt.append(...kpiAmtRow);
  }

  renderOverviewSummary();
}

function renderOverviewSummary(){
  const box=document.getElementById('overview-summary'); if(!box) return; box.innerHTML='';
  const {present:pc, counts} = getChannelCounts();
  const {present:pa, amts} = getChannelAmounts();
  const present = Array.from(new Set([...pc, ...pa]));
  const tileMode = (document.getElementById('sel-tile-metric')||{value:'both'}).value;
  for(const ch of present){
    const cnt = counts[ch]||0; const amt = amts[ch]||0;
    const div = document.createElement('div');
    const color = TILE_COLORS[ch] || 'bg-gray-50';
    div.className = `rounded p-3 text-center ${color}`;
    let inner = `<div class='text-xs uppercase tracking-wide text-gray-600 mb-1'>${ch}</div>`;
    if(tileMode==='count'||tileMode==='both') inner += `<div class='text-base font-semibold'>${cnt.toLocaleString()} <span class='text-xs text-gray-500'>count</span></div>`;
    if(tileMode==='amount'||tileMode==='both') inner += `<div class='text-base font-semibold'>${fmtINR.format(amt)} <span class='text-xs text-gray-500'>amount</span></div>`;
    div.innerHTML = inner; box.appendChild(div);
  }
}

// ===== Charts =====
let chartChannels=null, chartTop=null, chartChannels2=null, chartTop2=null, chartOfficeStack=null; let chartType='bar';
function effectiveMetric(selectId){ const sel=document.getElementById(selectId); const v= sel? sel.value : 'global'; return v==='global'? STATE.globalMetric : v; }
function dataByMetric(metric){
  if(metric==='amount'){ const {present, amts}=getChannelAmounts(); return {labels:present, values:present.map(ch=> amts[ch]||0)}; }
  const {present, counts}=getChannelCounts(); return {labels:present, values:present.map(ch=> counts[ch]||0)};
}
function renderCharts(){
  const mainMetric = effectiveMetric('sel-chart-metric-main');
  const {labels, values} = dataByMetric(mainMetric);
  const canvas = document.getElementById('chart-channels'); if(canvas){ const ctx=canvas.getContext('2d'); if(chartChannels) chartChannels.destroy(); chartChannels = new Chart(ctx,{type: chartType, data:{labels, datasets:[{label: mainMetric==='amount'?'Amount (₹)':'Transactions (count)', data: values}]}, options:{responsive:true}}); }

  // Top offices by digital % based on metric
  const ctx2El = document.getElementById('chart-top-offices');
  if(ctx2El){
    const metric = mainMetric;
    const ctx2 = ctx2El.getContext('2d');
    const officeMap={};
    for(const r of STATE.filteredData){ const o=r['office-name']||r['office']||'Unknown'; officeMap[o]=officeMap[o]||{cash:0,digital:0}; if(metric==='amount'){ officeMap[o].cash += sumNumeric(r,['cash'].filter(c=>SETTINGS.columns.includes('cash'))); officeMap[o].digital += sumNumeric(r, SETTINGS.digitalChannels.filter(c=>SETTINGS.columns.includes(c))); } else { officeMap[o].cash += sumCount(r,['cash'].filter(c=>SETTINGS.columns.includes('cash'))); officeMap[o].digital += sumCount(r, SETTINGS.digitalChannels.filter(c=>SETTINGS.columns.includes(c))); } }
    const arr = Object.keys(officeMap).map(o=>({office:o, pct: (officeMap[o].cash+officeMap[o].digital)>0? (officeMap[o].digital/(officeMap[o].cash+officeMap[o].digital))*100:0})).sort((a,b)=>b.pct-a.pct).slice(0,10);
    if(chartTop) chartTop.destroy(); chartTop = new Chart(ctx2,{type:'bar', data:{labels:arr.map(t=>t.office), datasets:[{label:'Digital %', data:arr.map(t=>t.pct)}]}, options:{indexAxis:'y',responsive:true}});
  }
}
function renderCharts2(){
  const typ2 = (document.getElementById('sel-chart-type-2')||{value:chartType}).value||chartType;
  const met2 = effectiveMetric('sel-chart-metric-2');
  const {labels, values} = dataByMetric(met2);
  const can1=document.getElementById('chart-channels-2'); if(can1){ const ctx=can1.getContext('2d'); if(chartChannels2) chartChannels2.destroy(); chartChannels2 = new Chart(ctx,{type: typ2, data:{labels, datasets:[{label: met2==='amount'?'Amount (₹)':'Transactions (count)', data: values}]}, options:{responsive:true}}); }

  // Top offices by digital (bar, 20)
  const metOff = effectiveMetric('sel-office-metric');
  const ctxOffEl = document.getElementById('chart-top-offices-2'); if(ctxOffEl){ const ctx=ctxOffEl.getContext('2d'); const officeMap={}; for(const r of STATE.filteredData){ const o=r['office-name']||r['office']||'Unknown'; officeMap[o]=officeMap[o]||{digital:0}; if(metOff==='amount'){ officeMap[o].digital += sumNumeric(r, SETTINGS.digitalChannels.filter(c=>SETTINGS.columns.includes(c))); } else { officeMap[o].digital += sumCount(r, SETTINGS.digitalChannels.filter(c=>SETTINGS.columns.includes(c))); } } const arr=Object.keys(officeMap).map(o=>({office:o, v:officeMap[o].digital})).sort((a,b)=>b.v-a.v).slice(0,20); if(chartTop2) chartTop2.destroy(); chartTop2 = new Chart(ctx,{type:'bar', data:{labels:arr.map(a=>a.office), datasets:[{label: metOff==='amount'?'Digital (₹)':'Digital (count)', data:arr.map(a=>a.v)}]}, options:{indexAxis:'y',responsive:true}}); }

  // Stacked Cash vs Digital
  const metStack = effectiveMetric('sel-office-stack-metric');
  const stEl = document.getElementById('chart-office-stacked'); if(stEl){ const ctx=stEl.getContext('2d'); const officeMap={}; for(const r of STATE.filteredData){ const o=r['office-name']||r['office']||'Unknown'; officeMap[o]=officeMap[o]||{cash:0,digital:0}; if(metStack==='amount'){ officeMap[o].cash += sumNumeric(r,['cash'].filter(c=>SETTINGS.columns.includes('cash'))); officeMap[o].digital += sumNumeric(r, SETTINGS.digitalChannels.filter(c=>SETTINGS.columns.includes(c))); } else { officeMap[o].cash += sumCount(r,['cash'].filter(c=>SETTINGS.columns.includes('cash'))); officeMap[o].digital += sumCount(r, SETTINGS.digitalChannels.filter(c=>SETTINGS.columns.includes(c))); } } const labels=Object.keys(officeMap); const cash=labels.map(o=>officeMap[o].cash); const dig=labels.map(o=>officeMap[o].digital); if(chartOfficeStack) chartOfficeStack.destroy(); chartOfficeStack = new Chart(ctx,{type:'bar', data:{labels, datasets:[{label:'Cash', data:cash, stack:'tot'},{label:'Digital', data:dig, stack:'tot'}]}, options:{responsive:true, scales:{x:{stacked:true}, y:{stacked:true}}}}); }
}

function renderAll(){ renderKPIs(); renderCharts(); renderCharts2(); }

// ===== Exports & Template =====
function exportCSV(){ if(!STATE.filteredData.length){ alert('No data loaded'); return } const cols = SETTINGS.columns; const csv = Papa.unparse({fields:cols, data: STATE.filteredData.map(r=>cols.map(c=>r[c]||''))}); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); saveAs(blob, 'exported-data.csv'); }
function exportPDF(){ if(!STATE.filteredData.length){ alert('No data loaded'); return } const { jsPDF } = window.jspdf; const doc = new jsPDF(); const cols = SETTINGS.columns.slice(0,10); const rows = STATE.filteredData.map(r=>cols.map(c=>r[c]||'')); doc.text('Digital Transactions Report', 14, 16); doc.autoTable({startY:22, head:[cols], body:rows}); doc.save('report.pdf'); }
function downloadTemplate(){ const cols = SETTINGS.columns.length?SETTINGS.columns:['office-name','office-id','cash','cheque','credit-card','debit-card','upi','neft','rtgs','wallet','qr-scan','product-name']; const csv = Papa.unparse({fields:cols, data: []}); const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); saveAs(blob,'dt_template.csv'); }
function importSettings(){ const txt = prompt('Paste settings JSON'); if(!txt) return; try{ const s = JSON.parse(txt); SETTINGS = s; saveSettings(); alert('Imported'); renderAll(); }catch(e){ alert('Invalid JSON') } }

// ===== File & Controls Events =====
function bindEvents(){
  document.getElementById('btn-login').addEventListener('click', login);
  document.getElementById('btn-logout').addEventListener('click', logout);
  document.getElementById('btn-reset-data').addEventListener('click', async ()=>{ if(!confirm('Reset to defaults?')) return; localStorage.clear(); await initDefaults(); location.reload(); });
  document.querySelectorAll('.tab-btn').forEach(btn=> btn.addEventListener('click', ()=> showTab(btn.dataset.tab)));
  // Global metric
  document.querySelectorAll('input[name="globalMetric"]').forEach(r=> r.addEventListener('change', (e)=>{ STATE.globalMetric=e.target.value; renderAll(); }));
  document.getElementById('chk-dual-kpi').addEventListener('change', (e)=>{ STATE.dualKPI=e.target.checked; renderAll(); });
  document.getElementById('sel-tile-metric').addEventListener('change', ()=> renderOverviewSummary());
  // Per-chart controls
  const selType = document.getElementById('sel-chart-type'); if(selType){ selType.addEventListener('change', ()=>{ chartType = selType.value; renderCharts(); }); }
  const selType2 = document.getElementById('sel-chart-type-2'); if(selType2){ selType2.addEventListener('change', ()=> renderCharts2()); }
  const selMetMain = document.getElementById('sel-chart-metric-main'); if(selMetMain){ selMetMain.addEventListener('change', ()=> renderCharts()); }
  const selMet2 = document.getElementById('sel-chart-metric-2'); if(selMet2){ selMet2.addEventListener('change', ()=> renderCharts2()); }
  const selOff = document.getElementById('sel-office-metric'); if(selOff){ selOff.addEventListener('change', ()=> renderCharts2()); }
  const selOffS = document.getElementById('sel-office-stack-metric'); if(selOffS){ selOffS.addEventListener('change', ()=> renderCharts2()); }
  // Data controls
  const tUp=document.getElementById('template-upload'); if(tUp) tUp.addEventListener('change', function(e){ const f=e.target.files[0]; if(!f) return; Papa.parse(f,{header:true,skipEmptyLines:true,complete:function(res){ SETTINGS.columns=Object.keys(res.data[0]||{}); saveSettings(); renderAll(); alert('Template loaded.'); }}); });
  const csvUp=document.getElementById('csv-upload'); if(csvUp) csvUp.addEventListener('change', e=> handleCSVFile(e.target.files[0]));
  const fo=document.getElementById('filter-office'); if(fo) fo.addEventListener('change', applyFilters);
  const st=document.getElementById('search-text'); if(st) st.addEventListener('input', applyFilters);
  document.getElementById('btn-export-csv').addEventListener('click', exportCSV);
  document.getElementById('btn-export-pdf').addEventListener('click', exportPDF);
  document.getElementById('btn-download-template').addEventListener('click', downloadTemplate);
  document.getElementById('export-settings').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(SETTINGS,null,2)],{type:'application/json'}); saveAs(blob,'dt_settings.json'); });
  document.getElementById('import-settings').addEventListener('click', importSettings);
  // User list actions
  document.getElementById('btn-add-user').addEventListener('click', addOrUpdateUser);
  document.getElementById('user-list').addEventListener('click', async function(e){ if(e.target.classList.contains('btn-del')){ const u=e.target.dataset.user; deleteUser(u);} if(e.target.classList.contains('btn-edit')){ const u=e.target.dataset.user; const users=JSON.parse(localStorage.getItem('dt_users')); document.getElementById('new-username').value=u; document.getElementById('new-password').value=''; document.getElementById('new-role').value=users[u].role; }});
}

// ===== CSV & Admin =====
function handleCSVFile(file){ if(!file) return; Papa.parse(file,{header:true,skipEmptyLines:true,complete:function(results){ STATE.rawData=results.data; SETTINGS.columns=Object.keys(STATE.rawData[0]||{}); saveSettings(); prepareFilters(); applyFilters(); }}); }
async function addOrUpdateUser(){ const u=document.getElementById('new-username').value.trim(); const p=document.getElementById('new-password').value; const r=document.getElementById('new-role').value; if(!u||!p){ alert('username & password required'); return } const users=JSON.parse(localStorage.getItem('dt_users')); users[u]={passwordHash: await sha256(p), role:r}; localStorage.setItem('dt_users', JSON.stringify(users)); renderUserList(); document.getElementById('new-username').value=''; document.getElementById('new-password').value=''; }
function deleteUser(username){ if(!confirm('Delete user '+username+'?')) return; const users=JSON.parse(localStorage.getItem('dt_users')); delete users[username]; localStorage.setItem('dt_users', JSON.stringify(users)); renderUserList(); }
function renderUserList(){ const ul=document.getElementById('user-list'); if(!ul) return; ul.innerHTML=''; const users=JSON.parse(localStorage.getItem('dt_users')); for(const k of Object.keys(users)){ const li=document.createElement('li'); li.className='flex justify-between'; li.innerHTML = `<span>${k} (${users[k].role})</span><span><button data-user='${k}' class='btn-edit text-xs mr-1'>Edit</button><button data-user='${k}' class='btn-del text-xs text-red-600'>Delete</button></span>`; ul.appendChild(li); } }

// ===== Boot =====
(async()=>{ await initDefaults(); loadSession(); if(STATE.user) location.hash = '#/dashboard'; else location.hash = '#/login'; bindEvents(); renderUserList(); navigate(); })();
</script>
</body>
</html>
